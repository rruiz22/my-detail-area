# DetailHub E2E Testing Checklist

**Version**: 1.0.0
**Last Updated**: 2025-11-18
**Module**: DetailHub - TSheets-like Time Tracking System
**Status**: Phase 1 Complete - Ready for E2E Validation

---

## Table of Contents

1. [Pre-Testing Setup](#1-pre-testing-setup)
2. [Test Flows](#2-test-flows)
3. [Database Verification Queries](#3-database-verification-queries)
4. [Error Cases](#4-error-cases)
5. [Performance Checks](#5-performance-checks)
6. [Translation Verification](#6-translation-verification)
7. [Sign-Off Checklist](#7-sign-off-checklist)

---

## 1. Pre-Testing Setup

### 1.1 Environment Requirements

#### **Development Environment**
```bash
# Start local development server
npm run dev

# Verify server is running on http://localhost:8080
# Port 8080 is MANDATORY (strictPort: true in vite.config)
```

#### **Staging Environment** (Recommended for comprehensive testing)
- **URL**: https://mydetailarea-staging.railway.app
- **Supabase**: Production database (swfnnrpzpkdypbrzmgnr)
- **Environment**: `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` configured

### 1.2 Test Data Requirements

#### **1.2.1 Dealerships**
Create at least 2 dealerships to test multi-dealership isolation:

```sql
-- Dealership A (Test Dealership 1)
INSERT INTO dealerships (dealer_name, dealer_code, dealer_city, dealer_state)
VALUES ('Premium Auto Group', 'PAG001', 'Miami', 'FL');

-- Dealership B (Test Dealership 2)
INSERT INTO dealerships (dealer_name, dealer_code, dealer_city, dealer_state)
VALUES ('Elite Motors', 'ELI002', 'Orlando', 'FL');
```

#### **1.2.2 Test User Setup**
Create test users with appropriate permissions:

```sql
-- System Admin (for oversight)
-- Email: admin@detailhub.test
-- Permissions: Full access to DetailHub module

-- Dealer Manager (for Dealership A)
-- Email: manager-a@detailhub.test
-- Permissions: detail_hub (read, write, admin)

-- Dealer Manager (for Dealership B)
-- Email: manager-b@detailhub.test
-- Permissions: detail_hub (read, write, admin)
```

#### **1.2.3 Employees**
**DO NOT create employees manually** - Employee creation is part of Test Flow 1.

Expected auto-generated employee numbers:
- First employee: `EMP001`
- Second employee: `EMP002`
- Third employee: `EMP003`
- etc.

### 1.3 Database State Requirements

#### **1.3.1 Clean State**
Before testing, ensure:

```sql
-- Verify no orphaned time entries
SELECT COUNT(*) FROM detail_hub_time_entries
WHERE employee_id NOT IN (SELECT id FROM detail_hub_employees);
-- Expected: 0

-- Verify RLS policies are active
SELECT schemaname, tablename, policyname, permissive
FROM pg_policies
WHERE tablename LIKE 'detail_hub_%';
-- Expected: Multiple policies for each table
```

#### **1.3.2 Kiosk Setup**
Create at least 2 kiosks for testing:

```sql
INSERT INTO detail_hub_kiosks (dealership_id, kiosk_code, kiosk_name, location, status)
VALUES
  ((SELECT id FROM dealerships WHERE dealer_code = 'PAG001'), 'KIOSK-001', 'Front Desk', 'Main Entrance', 'active'),
  ((SELECT id FROM dealerships WHERE dealer_code = 'PAG001'), 'KIOSK-002', 'Detail Shop', 'Service Area', 'active');
```

### 1.4 Browser/Device Setup

#### **Recommended Test Matrix**
| Browser | Version | Device | Camera Required |
|---------|---------|--------|-----------------|
| Chrome | Latest | Desktop | Yes |
| Firefox | Latest | Desktop | Yes |
| Safari | Latest | macOS | Yes |
| Chrome | Latest | Android | Yes (mobile camera) |
| Safari | Latest | iOS | Yes (mobile camera) |

#### **Camera Permissions**
- **CRITICAL**: Grant camera access when prompted
- Test photo capture on both front/rear cameras (mobile)
- Verify camera permissions persist across sessions

#### **Network Conditions**
Test under various network conditions:
- **Fast 3G**: Simulated in Chrome DevTools
- **Slow 3G**: Verify photo upload handling
- **Offline**: Test error messages

---

## 2. Test Flows

### Flow 1: Employee Management ⭐ FOUNDATION

**Purpose**: Verify employee CRUD operations and auto-generated employee numbers.

#### **Step 1.1: Create First Employee**

**Actions**:
1. Navigate to `DetailHub > Employees` tab
2. Click **"Add Employee"** button
3. Fill employee form:
   - **First Name**: John
   - **Last Name**: Smith
   - **Email**: john.smith@detailhub.test
   - **Phone**: +1-555-0100
   - **Role**: Detailer
   - **Department**: Detail
   - **Hourly Rate**: $25.00
   - **Hire Date**: Today's date
   - **Status**: Active
4. Click **"Save Employee"**

**Expected Results**:
- ✅ Employee created successfully
- ✅ Toast notification: "Employee Created"
- ✅ **Employee Number**: `EMP001` (auto-generated by database trigger)
- ✅ Employee appears in employee list
- ✅ Employee card shows full name "John Smith"
- ✅ Employee card shows employee number "EMP001"

#### **Step 1.2: Create Second Employee**

**Actions**:
1. Click **"Add Employee"** again
2. Fill form:
   - **First Name**: Maria
   - **Last Name**: Garcia
   - **Email**: maria.garcia@detailhub.test
   - **Phone**: +1-555-0101
   - **Role**: Car Wash
   - **Department**: Car Wash
   - **Hourly Rate**: $20.00
   - **Hire Date**: Today's date
   - **Status**: Active
3. Click **"Save Employee"**

**Expected Results**:
- ✅ Employee created successfully
- ✅ **Employee Number**: `EMP002` (sequential auto-increment)
- ✅ Employee appears in list below EMP001

#### **Step 1.3: Edit Employee Details**

**Actions**:
1. Click **"Edit"** button on John Smith (EMP001)
2. Update:
   - **Hourly Rate**: $28.00
   - **Phone**: +1-555-0199
3. Click **"Save"**

**Expected Results**:
- ✅ Toast notification: "Employee Updated"
- ✅ Employee card reflects new hourly rate
- ✅ Employee number remains `EMP001` (unchanged)

#### **Step 1.4: Search/Filter Employees**

**Actions**:
1. In employee search box, type: "john"
2. Clear search
3. Filter by **Department**: "Detail"
4. Clear filter
5. Filter by **Status**: "Active"

**Expected Results**:
- ✅ Search shows only John Smith
- ✅ Department filter shows only Detail department employees
- ✅ Status filter shows only active employees
- ✅ All filters work independently and combinable

#### **Step 1.5: Assign PIN Code**

**Actions**:
1. Click **"Edit"** on John Smith
2. Scroll to **"Kiosk PIN"** field
3. Enter: `1234`
4. Click **"Save"**

**Expected Results**:
- ✅ PIN saved successfully
- ✅ PIN field shows masked dots (••••) in view mode
- ✅ PIN is editable in edit mode

#### **Step 1.6: Verify Employee in Lists**

**Actions**:
1. Navigate to `DetailHub > Schedules` tab
2. Click **"Assign Shift"** button
3. Open employee dropdown

**Expected Results**:
- ✅ Both EMP001 (John Smith) and EMP002 (Maria Garcia) appear in dropdown
- ✅ Employee names displayed (not IDs)
- ✅ Employee numbers shown in parentheses

---

### Flow 2: Schedule Management ⭐ SCHEDULING

**Purpose**: Verify shift creation, kiosk assignment, break policies, and conflict detection.

#### **Step 2.1: Create Shift for Employee**

**Actions**:
1. Navigate to `DetailHub > Schedules` tab
2. Click **"Assign Shift"** button
3. Fill shift form:
   - **Employee**: John Smith (EMP001)
   - **Date**: Tomorrow's date
   - **Start Time**: 08:00 AM
   - **End Time**: 05:00 PM
   - **Break Required**: 30 minutes
   - **Break Paid**: No
   - **Kiosk**: KIOSK-001 (Front Desk)
   - **Status**: Scheduled
4. Click **"Save Shift"**

**Expected Results**:
- ✅ Toast notification: "Schedule Created"
- ✅ Shift appears in calendar view
- ✅ Shift card shows:
  - Employee name: "John Smith"
  - Time: "08:00 AM - 05:00 PM"
  - Duration: 9 hours
  - Kiosk: "KIOSK-001"
  - Break: "30 min (unpaid)"

#### **Step 2.2: Assign Kiosk to Shift**

**Actions**:
1. Click **"Edit"** on the shift just created
2. Change **Kiosk** to: KIOSK-002 (Detail Shop)
3. Click **"Save"**

**Expected Results**:
- ✅ Toast notification: "Schedule Updated"
- ✅ Shift card now shows "KIOSK-002"

#### **Step 2.3: Set Break Policy (30 min minimum)**

**Actions**:
1. Create another shift for Maria Garcia (EMP002)
2. Fill form:
   - **Date**: Tomorrow
   - **Start Time**: 09:00 AM
   - **End Time**: 06:00 PM (9 hours - requires break)
   - **Break Required**: 45 minutes
   - **Break Paid**: Yes
3. Click **"Save"**

**Expected Results**:
- ✅ Shift created successfully
- ✅ Break policy: "45 min (paid)"
- ✅ System accepts break ≥ 30 minutes

#### **Step 2.4: Test Conflict Detection (Overlapping Shifts)**

**Actions**:
1. Try to create another shift for John Smith (EMP001)
2. Fill form:
   - **Date**: Tomorrow (same date as existing shift)
   - **Start Time**: 03:00 PM (overlaps with 08:00 AM - 05:00 PM)
   - **End Time**: 08:00 PM
3. Click **"Save"**

**Expected Results**:
- ❌ Error toast: "Schedule conflict detected. Employee already has a shift scheduled for this date."
- ❌ Shift NOT created
- ✅ Original shift remains intact

#### **Step 2.5: Verify Schedule in Calendar View**

**Actions**:
1. Navigate to calendar view
2. Select tomorrow's date
3. Verify all shifts appear

**Expected Results**:
- ✅ Calendar shows 2 shifts for tomorrow:
  - John Smith: 08:00 AM - 05:00 PM (KIOSK-002)
  - Maria Garcia: 09:00 AM - 06:00 PM (KIOSK-001)
- ✅ Shifts color-coded by department
- ✅ Clicking shift opens detail view

---

### Flow 3: Punch Clock Workflow ⭐⭐⭐ CRITICAL

**Purpose**: Test complete clock in/out cycle with photo capture, break management, and hours calculation.

**IMPORTANT**: This flow tests the core time tracking functionality with photo verification.

#### **Step 3.1: Clock In with Photo**

**Actions**:
1. Open Kiosk Mode: Navigate to `/kiosk?kiosk_id=KIOSK-002`
   - Or click **"Time Clock"** button in dashboard
2. Enter **Employee ID**: `EMP001`
3. Enter **PIN**: `1234`
4. Verify validation message shows:
   - ✅ Green check: "Allowed to punch in (5 min early window)"
   - ✅ Scheduled time: "08:00 AM - 05:00 PM"
5. Click **"Clock In"** button
6. **Camera activates** (browser permission prompt)
7. Allow camera access
8. Position face in green guide box
9. Click **"Capture Photo"** button
10. Review captured photo
11. Click **"Confirm"** button

**Expected Results**:
- ✅ Camera preview appears
- ✅ Photo captured successfully (base64 image)
- ✅ Status: "Uploading photo..."
- ✅ Status: "Processing punch..."
- ✅ Photo uploads to Supabase Storage: `detail-hub-photos/{dealership_id}/{employee_id}/clock_in_{timestamp}.jpg`
- ✅ Toast notification: "Photo captured. Awaiting supervisor approval."
- ✅ Time entry created in database
- ✅ Form resets (employee ID and PIN cleared)
- ✅ Employee appears in "Who's Working Now" dashboard

**Database Verification**:
```sql
SELECT
  te.*,
  e.first_name,
  e.last_name,
  e.employee_number
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_employees e ON te.employee_id = e.id
WHERE e.employee_number = 'EMP001'
ORDER BY te.clock_in DESC
LIMIT 1;

-- Expected fields populated:
-- clock_in: [current timestamp]
-- photo_in_url: https://swfnnrpzpkdypbrzmgnr.supabase.co/storage/v1/object/public/detail-hub-photos/...
-- punch_in_method: 'photo_fallback'
-- requires_manual_verification: true
-- status: 'active'
-- schedule_id: [linked to schedule]
```

#### **Step 3.2: Verify Schedule Validation**

**Actions**:
1. Try to clock in EMP002 (Maria Garcia) **1 hour early** (before 08:55 AM)
2. Enter Employee ID: `EMP002`
3. Enter PIN: `5678`

**Expected Results**:
- ❌ Yellow warning: "Not within punch window (XX minutes remaining)"
- ❌ **Clock In** button DISABLED
- ✅ Shows scheduled time: "09:00 AM - 06:00 PM"

#### **Step 3.3: Start Break with Photo**

**Actions**:
1. Wait 30+ minutes after clock in (or simulate by updating database timestamp)
2. In kiosk, enter Employee ID: `EMP001`
3. Enter PIN: `1234`
4. Click **"Start Break"** button
5. Camera activates
6. Capture photo
7. Confirm

**Expected Results**:
- ✅ Photo captured
- ✅ Photo uploads to Storage
- ✅ Toast: "Break Started"
- ✅ `break_start` timestamp populated in database
- ✅ Employee status in dashboard: "On Break" (amber badge)

**Database Verification**:
```sql
SELECT break_start, break_end, break_duration_minutes
FROM detail_hub_time_entries
WHERE employee_id = (SELECT id FROM detail_hub_employees WHERE employee_number = 'EMP001')
  AND status = 'active';

-- Expected:
-- break_start: [timestamp]
-- break_end: null
-- break_duration_minutes: 0 (not calculated until break ends)
```

#### **Step 3.4: End Break with Photo**

**Actions**:
1. Wait 30+ minutes (or simulate)
2. In kiosk, enter Employee ID: `EMP001`
3. Enter PIN: `1234`
4. Click **"End Break"** button
5. Capture photo
6. Confirm

**Expected Results**:
- ✅ Photo captured and uploaded
- ✅ Toast: "Break Ended. Duration: XX minutes"
- ✅ `break_end` timestamp populated
- ✅ `break_duration_minutes` auto-calculated
- ✅ Employee status returns to "Active" (green badge)

**Database Verification**:
```sql
SELECT
  break_start,
  break_end,
  break_duration_minutes,
  EXTRACT(EPOCH FROM (break_end::timestamp - break_start::timestamp)) / 60 AS calculated_minutes
FROM detail_hub_time_entries
WHERE employee_id = (SELECT id FROM detail_hub_employees WHERE employee_number = 'EMP001')
  AND status = 'active';

-- Expected:
-- break_duration_minutes MATCHES calculated_minutes (within 1 min tolerance)
```

#### **Step 3.5: Clock Out with Photo**

**Actions**:
1. After work shift (or simulate end of day)
2. In kiosk, enter Employee ID: `EMP001`
3. Enter PIN: `1234`
4. Click **"Clock Out"** button
5. Capture photo
6. Confirm

**Expected Results**:
- ✅ Photo captured and uploaded to `photo_out_url`
- ✅ `clock_out` timestamp populated
- ✅ Toast: "Clocked Out. Total hours: X.XX"
- ✅ Status changes from `active` to `complete`
- ✅ Hours auto-calculated by database trigger:
  - `total_hours` = (clock_out - clock_in) - break_duration
  - `regular_hours` = min(total_hours, 8.0)
  - `overtime_hours` = max(total_hours - 8.0, 0)
- ✅ Employee disappears from "Who's Working Now" dashboard

**Database Verification**:
```sql
SELECT
  clock_in,
  clock_out,
  break_duration_minutes,
  total_hours,
  regular_hours,
  overtime_hours,
  EXTRACT(EPOCH FROM (clock_out::timestamp - clock_in::timestamp)) / 3600 AS raw_hours,
  photo_in_url,
  photo_out_url
FROM detail_hub_time_entries
WHERE employee_id = (SELECT id FROM detail_hub_employees WHERE employee_number = 'EMP001')
ORDER BY clock_in DESC
LIMIT 1;

-- Expected calculations (example):
-- clock_in: 08:00 AM
-- clock_out: 05:30 PM
-- break_duration_minutes: 30
-- raw_hours: 9.5
-- total_hours: 9.0 (9.5 - 0.5 break)
-- regular_hours: 8.0
-- overtime_hours: 1.0
-- photo_in_url: [URL]
-- photo_out_url: [URL]
```

---

### Flow 4: Photo Review/Approval ⭐⭐ SUPERVISOR WORKFLOW

**Purpose**: Verify supervisor photo review and approval/rejection workflow.

#### **Step 4.1: Navigate to Timecards Tab**

**Actions**:
1. Navigate to `DetailHub > Timecards` tab
2. Scroll to **"Pending Photo Reviews"** section

**Expected Results**:
- ✅ Section visible with yellow/amber border
- ✅ Badge shows pending count: "X Pending"
- ✅ Photo review cards displayed in grid (3 columns on desktop)

#### **Step 4.2: Verify Pending Reviews Show Employee Names (NOT IDs)**

**Actions**:
1. Inspect photo review cards
2. Verify data displayed

**Expected Results**:
- ✅ **Employee Name**: "John Smith" (NOT UUID)
- ✅ **Employee Number**: "EMP001"
- ✅ **Clock In Time**: Human-readable timestamp
- ✅ **Photo**: Thumbnail of captured photo
- ✅ **Actions**: "Approve" and "Reject" buttons

**CRITICAL FIX VERIFICATION** (Phase 1):
```sql
-- Verify JOIN works in pending reviews query
SELECT
  te.*,
  e.first_name || ' ' || e.last_name AS employee_name,
  e.employee_number
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_employees e ON te.employee_id = e.id
WHERE te.requires_manual_verification = true
  AND te.verified_at IS NULL;

-- Expected: No NULL employee_name values
```

#### **Step 4.3: Approve a Time Entry**

**Actions**:
1. Click **"Approve"** button on a pending review card
2. Confirm approval in modal (if present)

**Expected Results**:
- ✅ Toast notification: "Punch Approved"
- ✅ Card disappears from "Pending Reviews" section
- ✅ Pending count decreases by 1
- ✅ Database fields updated:
  - `requires_manual_verification`: false
  - `verified_by`: [current user's UUID]
  - `verified_at`: [current timestamp]

**Database Verification**:
```sql
SELECT
  requires_manual_verification,
  verified_by,
  verified_at
FROM detail_hub_time_entries
WHERE id = '[time_entry_id]';

-- Expected:
-- requires_manual_verification: false
-- verified_by: [UUID of supervisor]
-- verified_at: [recent timestamp]
```

#### **Step 4.4: Reject a Time Entry**

**Actions**:
1. Click **"Reject"** button on another pending review
2. Confirm rejection

**Expected Results**:
- ✅ Toast notification: "Punch Rejected"
- ✅ Card disappears from pending reviews
- ✅ **Time entry DELETED from database** (not just marked)
- ✅ Pending count decreases by 1

**Database Verification**:
```sql
SELECT COUNT(*)
FROM detail_hub_time_entries
WHERE id = '[rejected_time_entry_id]';

-- Expected: 0 (entry completely removed)
```

---

### Flow 5: Live Dashboard ⭐ REAL-TIME MONITORING

**Purpose**: Verify real-time dashboard updates and employee name display.

#### **Step 5.1: Navigate to Overview Tab**

**Actions**:
1. Navigate to `DetailHub > Overview` tab
2. Observe "Who's Working Now" section

**Expected Results**:
- ✅ Dashboard loads within 3 seconds
- ✅ Real-time stats displayed:
  - Clocked In: [count]
  - On Break: [count]
  - Total Hours Today: [sum]
  - Active Departments: [count]

#### **Step 5.2: Verify "Who's Working Now" Shows Employee Names**

**Actions**:
1. Inspect employee cards in grid view
2. Click **List View** button
3. Inspect list view

**Expected Results**:
- ✅ **Employee Name**: "John Smith" (NOT employee_id UUID)
- ✅ **Employee Number**: "EMP001"
- ✅ **Status Badge**:
  - Green "Active" with pulse animation (if working)
  - Amber "On Break" with coffee icon (if on break)
- ✅ **Profile Photo**: Initials avatar (JS) if no photo
- ✅ **Department**: Badge showing "Detail"
- ✅ **Kiosk**: Badge showing "KIOSK-002"

**Database Verification** (Phase 1 Fix):
```sql
-- Verify live dashboard view includes employee names
SELECT * FROM detail_hub_currently_working
WHERE dealership_id = [dealership_id]
LIMIT 5;

-- Expected columns:
-- employee_name: 'John Smith'
-- employee_number: 'EMP001'
-- NOT: employee_id UUID alone
```

#### **Step 5.3: Verify Elapsed Time Counters Update**

**Actions**:
1. Wait 60 seconds
2. Observe elapsed time display

**Expected Results**:
- ✅ Elapsed time updates in real-time (HH:MM:SS format)
- ✅ Format example: "01:23:45" (1 hour, 23 minutes, 45 seconds)
- ✅ Counter increments every second (via `useElapsedTime` hook)

#### **Step 5.4: Verify Stats Cards**

**Actions**:
1. Inspect dashboard stats
2. Clock in another employee
3. Refresh dashboard

**Expected Results**:
- ✅ **Clocked In** count increases by 1
- ✅ **Total Hours Today** updates (sum of all active entries)
- ✅ Stats refresh automatically (30s interval via React Query)

---

### Flow 6: Multi-Dealership Isolation ⭐⭐⭐ SECURITY CRITICAL

**Purpose**: Verify Row-Level Security (RLS) prevents data leakage between dealerships.

#### **Step 6.1: Create Employees in Dealership A**

**Actions**:
1. Login as `manager-a@detailhub.test`
2. Select **Dealership**: "Premium Auto Group" in filter
3. Create 2 employees:
   - Alice Johnson (EMP001 in Dealership A)
   - Bob Williams (EMP002 in Dealership A)

**Expected Results**:
- ✅ Employees created successfully
- ✅ Both visible in employee list

#### **Step 6.2: Create Employees in Dealership B**

**Actions**:
1. Logout
2. Login as `manager-b@detailhub.test`
3. Select **Dealership**: "Elite Motors"
4. Create 2 employees:
   - Charlie Davis (EMP001 in Dealership B)
   - Diana Martinez (EMP002 in Dealership B)

**Expected Results**:
- ✅ Employees created successfully
- ✅ Employee numbers restart at EMP001 (per-dealership sequence)

#### **Step 6.3: Switch to Dealership A - Verify Isolation**

**Actions**:
1. Login as system admin
2. Select **Dealership Filter**: "Premium Auto Group"
3. Navigate to `DetailHub > Employees`
4. Navigate to `DetailHub > Overview`

**Expected Results**:
- ✅ **Employees Tab**: Only shows Alice and Bob (Dealership A)
- ✅ **Dashboard**: Only shows Dealership A time entries
- ❌ **ZERO visibility** of Charlie and Diana (Dealership B)

**Database Verification**:
```sql
-- As Dealership A user
SET LOCAL app.current_dealership_id = [dealership_a_id];

SELECT employee_number, first_name, last_name
FROM detail_hub_employees;

-- Expected: Only Alice and Bob
-- Charlie and Diana should NOT appear
```

#### **Step 6.4: Switch to Dealership B - Verify Reverse Isolation**

**Actions**:
1. Select **Dealership Filter**: "Elite Motors"
2. Navigate to employees
3. Navigate to time entries

**Expected Results**:
- ✅ Only shows Charlie and Diana
- ❌ Alice and Bob NOT visible
- ✅ Time entries scoped to Dealership B only

#### **Step 6.5: Verify Time Entry Isolation**

**Actions**:
1. As Dealership A manager, clock in Alice
2. Switch to Dealership B filter
3. Check "Who's Working Now" dashboard

**Expected Results**:
- ❌ Alice's time entry NOT visible in Dealership B view
- ✅ RLS policy enforces dealership_id filter
- ✅ Zero data leakage

**SQL Verification**:
```sql
-- Verify RLS policies exist
SELECT schemaname, tablename, policyname, cmd, qual
FROM pg_policies
WHERE tablename IN ('detail_hub_employees', 'detail_hub_time_entries');

-- Expected policies:
-- detail_hub_employees:
--   - SELECT: dealership_id = current_setting('app.current_dealership_id')::integer
--   - INSERT/UPDATE/DELETE: Same filter
-- detail_hub_time_entries: Same pattern
```

---

### Flow 7: Break Policy Enforcement ⭐ COMPLIANCE

**Purpose**: Verify break policy enforcement for shifts ≥ 6 hours.

#### **Step 7.1: Create Shift with 6+ Hour Duration**

**Actions**:
1. Create schedule for EMP001
2. **Start Time**: 08:00 AM
3. **End Time**: 03:00 PM (7 hours)
4. **Break Required**: 30 minutes
5. Save schedule

**Expected Results**:
- ✅ Schedule created
- ✅ System flags as requiring break

#### **Step 7.2: Clock In Employee**

**Actions**:
1. Clock in EMP001 at 08:00 AM
2. Work full shift without taking break

**Expected Results**:
- ✅ Clock in successful
- ⚠️ System should track "no break taken"

#### **Step 7.3: Try to Clock Out Without Taking Break**

**Actions**:
1. At 03:00 PM, attempt to clock out
2. Observe validation

**Expected Behavior** (Implementation-dependent):
- **Option A**: Warning modal: "No break taken. Shift requires 30 min break. Continue?"
- **Option B**: Violation flag set in database
- **Option C**: Auto-calculate unpaid break deduction

**Current Implementation**: No hard enforcement (future enhancement)

#### **Step 7.4: Verify Break Duration ≥ 30 Minutes**

**Actions**:
1. Clock in EMP002
2. Start break at 12:00 PM
3. End break at 12:25 PM (25 minutes)

**Expected Results**:
- ✅ Break recorded
- ⚠️ Break duration: 25 minutes (less than required 30)
- **Future Enhancement**: Flag for supervisor review

**Database Verification**:
```sql
SELECT
  employee_id,
  break_duration_minutes,
  s.required_break_minutes,
  CASE
    WHEN break_duration_minutes < s.required_break_minutes THEN 'VIOLATION'
    ELSE 'COMPLIANT'
  END AS break_compliance
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_schedules s ON te.schedule_id = s.id
WHERE te.break_duration_minutes IS NOT NULL;
```

---

### Flow 8: Recent Activity ⭐ AUDIT TRAIL

**Purpose**: Verify recent activity feed shows employee names (not IDs).

#### **Step 8.1: Perform Several Punches**

**Actions**:
1. Clock in EMP001
2. Wait 5 seconds
3. Clock in EMP002
4. Wait 5 seconds
5. Clock out EMP001

**Expected Results**:
- ✅ 3 time entries created

#### **Step 8.2: Navigate to Dashboard**

**Actions**:
1. Navigate to `DetailHub > Overview`
2. Scroll to "Recent Activity" section

**Expected Results**:
- ✅ Shows last 5 activities
- ✅ **Employee Names**: "John Smith", "Maria Garcia" (NOT UUIDs)
- ✅ **Action Type**: "Clocked In", "Clocked Out"
- ✅ **Timestamp**: Human-readable (e.g., "08:15 AM")
- ✅ **Status Badge**: Green for success, Yellow for warning

**CRITICAL FIX VERIFICATION** (Phase 1):
```sql
-- Verify recent activity query includes names
SELECT
  te.id,
  e.first_name || ' ' || e.last_name AS employee_name,
  te.clock_in,
  te.clock_out,
  CASE WHEN te.clock_out IS NULL THEN 'Clocked In' ELSE 'Clocked Out' END AS action
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_employees e ON te.employee_id = e.id
ORDER BY te.clock_in DESC
LIMIT 5;

-- Expected: All rows have employee_name populated
-- No NULL values
```

---

## 3. Database Verification Queries

### 3.1 Verify Time Entry Has Employee Data

```sql
-- Join time entries with employee info
SELECT
  te.id,
  te.clock_in,
  te.clock_out,
  te.total_hours,
  te.regular_hours,
  te.overtime_hours,
  te.break_duration_minutes,
  te.photo_in_url,
  te.photo_out_url,
  te.requires_manual_verification,
  te.status,
  e.employee_number,
  e.first_name,
  e.last_name,
  e.department,
  e.role
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_employees e ON te.employee_id = e.id
ORDER BY te.clock_in DESC
LIMIT 10;
```

**Expected Output**:
| id | clock_in | clock_out | total_hours | employee_number | first_name | last_name |
|----|----------|-----------|-------------|-----------------|------------|-----------|
| uuid1 | 2025-11-18 08:00 | 2025-11-18 17:00 | 8.5 | EMP001 | John | Smith |
| uuid2 | 2025-11-18 09:00 | NULL | NULL | EMP002 | Maria | Garcia |

### 3.2 Verify RLS Policies Work (Dealership Isolation)

```sql
-- As Dealership A user (set session variable)
SET LOCAL app.current_dealership_id = 1;

-- Attempt to query all employees
SELECT employee_number, first_name, dealership_id
FROM detail_hub_employees;

-- Expected: Only employees with dealership_id = 1

-- Try to access Dealership B's data directly
SELECT * FROM detail_hub_employees WHERE dealership_id = 2;

-- Expected: 0 rows (RLS blocks cross-dealership access)
```

### 3.3 Verify Hours Calculation Accuracy

```sql
-- Test hours calculation trigger
SELECT
  employee_id,
  clock_in,
  clock_out,
  break_duration_minutes,
  -- Manual calculation for verification
  EXTRACT(EPOCH FROM (clock_out::timestamp - clock_in::timestamp)) / 3600 AS raw_hours_calculated,
  (EXTRACT(EPOCH FROM (clock_out::timestamp - clock_in::timestamp)) / 3600) - (break_duration_minutes / 60.0) AS net_hours_calculated,
  -- Database-calculated values
  total_hours AS db_total_hours,
  regular_hours AS db_regular_hours,
  overtime_hours AS db_overtime_hours,
  -- Validation
  CASE
    WHEN ABS(total_hours - ((EXTRACT(EPOCH FROM (clock_out::timestamp - clock_in::timestamp)) / 3600) - (break_duration_minutes / 60.0))) < 0.01 THEN 'PASS'
    ELSE 'FAIL'
  END AS hours_validation
FROM detail_hub_time_entries
WHERE clock_out IS NOT NULL
ORDER BY clock_in DESC
LIMIT 20;
```

**Expected**: All rows show `hours_validation = 'PASS'`

### 3.4 Verify Photo URLs Are Accessible

```sql
-- Check photo URLs
SELECT
  e.employee_number,
  te.photo_in_url,
  te.photo_out_url,
  CASE WHEN te.photo_in_url IS NOT NULL THEN 'YES' ELSE 'NO' END AS has_clock_in_photo,
  CASE WHEN te.photo_out_url IS NOT NULL THEN 'YES' ELSE 'NO' END AS has_clock_out_photo
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_employees e ON te.employee_id = e.id
WHERE te.punch_in_method = 'photo_fallback'
   OR te.punch_out_method = 'photo_fallback'
ORDER BY te.clock_in DESC;
```

**Manual Verification**:
1. Copy a `photo_in_url` from results
2. Paste into browser
3. Verify photo loads (publicly accessible via Supabase Storage)

Expected URL format:
```
https://swfnnrpzpkdypbrzmgnr.supabase.co/storage/v1/object/public/detail-hub-photos/1/emp123/clock_in_1731878400000.jpg
```

### 3.5 Verify Break Compliance

```sql
-- Check break policy compliance
SELECT
  e.employee_number,
  e.first_name,
  s.shift_date,
  s.shift_start_time,
  s.shift_end_time,
  s.required_break_minutes,
  te.break_duration_minutes,
  CASE
    WHEN te.break_duration_minutes IS NULL THEN 'NO_BREAK_TAKEN'
    WHEN te.break_duration_minutes < s.required_break_minutes THEN 'INSUFFICIENT'
    ELSE 'COMPLIANT'
  END AS break_compliance_status
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_employees e ON te.employee_id = e.id
LEFT JOIN detail_hub_schedules s ON te.schedule_id = s.id
WHERE s.required_break_minutes > 0
ORDER BY te.clock_in DESC;
```

### 3.6 Verify Pending Reviews Query (Phase 1 Fix)

```sql
-- Verify pending reviews include employee names
SELECT
  te.id,
  te.employee_id,
  e.first_name || ' ' || e.last_name AS employee_name,
  e.employee_number,
  te.clock_in,
  te.photo_in_url,
  te.requires_manual_verification,
  te.verified_at
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_employees e ON te.employee_id = e.id
WHERE te.requires_manual_verification = true
  AND te.verified_at IS NULL
ORDER BY te.clock_in DESC;
```

**Expected**: `employee_name` column populated with full names (no NULLs)

---

## 4. Error Cases

### 4.1 Invalid PIN Code

**Test**: Enter wrong PIN

**Actions**:
1. Enter Employee ID: `EMP001`
2. Enter PIN: `9999` (wrong PIN)
3. Click "Clock In"

**Expected Results**:
- ❌ Error toast: "Invalid PIN code"
- ❌ Clock in blocked
- ✅ No time entry created

### 4.2 Punch Outside Schedule Window

**Test**: Try to clock in too early

**Actions**:
1. Schedule: 08:00 AM - 05:00 PM
2. Current time: 07:30 AM (30 min early, outside 5 min window)
3. Attempt to clock in

**Expected Results**:
- ❌ Validation message: "Not within punch window (25 minutes remaining)"
- ❌ Clock In button DISABLED
- ✅ Countdown timer shows minutes until allowed

### 4.3 Duplicate Clock In Attempt

**Test**: Try to clock in when already clocked in

**Actions**:
1. Clock in EMP001 successfully
2. Immediately try to clock in again

**Expected Results**:
- ❌ Error toast: "Employee is already clocked in"
- ❌ No duplicate time entry created

**Database Verification**:
```sql
-- Verify only one active entry per employee
SELECT COUNT(*)
FROM detail_hub_time_entries
WHERE employee_id = (SELECT id FROM detail_hub_employees WHERE employee_number = 'EMP001')
  AND status = 'active';

-- Expected: 1 (or 0 if clocked out)
```

### 4.4 Break Without Active Entry

**Test**: Try to start break when not clocked in

**Actions**:
1. Ensure EMP001 is NOT clocked in
2. Attempt to click "Start Break"

**Expected Results**:
- ❌ Error toast: "No active time entry found. Please clock in first."
- ❌ Break not recorded

### 4.5 Photo Upload Failure

**Test**: Simulate network error during photo upload

**Actions**:
1. Open Chrome DevTools > Network tab
2. Set throttling to "Offline"
3. Attempt to clock in with photo

**Expected Results**:
- ❌ Status message: "Upload failed. Please check connection."
- ❌ Retry button appears
- ❌ Time entry NOT created until photo upload succeeds

### 4.6 Camera Access Denied

**Test**: Block camera permissions

**Actions**:
1. In browser settings, block camera for site
2. Click "Clock In"
3. Observe error

**Expected Results**:
- ❌ Error message: "Camera access denied. Please enable camera."
- ❌ Fallback: Option to manually upload photo (future enhancement)
- ✅ User can re-enable camera in browser settings

---

## 5. Performance Checks

### 5.1 Dashboard Load Time

**Metric**: Time from navigation to full render

**Actions**:
1. Open Chrome DevTools > Performance tab
2. Navigate to `DetailHub > Overview`
3. Measure load time

**Acceptance Criteria**:
- ✅ **Initial load**: < 3 seconds
- ✅ **"Who's Working Now" data**: < 2 seconds
- ✅ **Stats cards**: < 1 second

**Measurement**:
```javascript
// In browser console
performance.mark('dashboard-start');
// [Navigate to dashboard]
performance.mark('dashboard-end');
performance.measure('dashboard-load', 'dashboard-start', 'dashboard-end');
console.log(performance.getEntriesByName('dashboard-load'));
```

### 5.2 Photo Upload Time

**Metric**: Time from capture to confirmation

**Actions**:
1. Capture photo (1280x720 resolution)
2. Measure upload duration

**Acceptance Criteria**:
- ✅ **Fast 4G**: < 2 seconds
- ✅ **3G**: < 5 seconds
- ✅ **Slow 3G**: < 10 seconds (with progress indicator)

**Network Simulation**:
- Chrome DevTools > Network > Throttling: "Slow 3G"

### 5.3 Query Response Time

**Metric**: Database query execution time

**Actions**:
1. Run complex query in Supabase SQL Editor
2. Measure execution time

**Test Query**:
```sql
EXPLAIN ANALYZE
SELECT
  te.*,
  e.first_name,
  e.last_name,
  e.employee_number
FROM detail_hub_time_entries te
LEFT JOIN detail_hub_employees e ON te.employee_id = e.id
WHERE te.dealership_id = 1
  AND te.clock_in >= NOW() - INTERVAL '7 days'
ORDER BY te.clock_in DESC;
```

**Acceptance Criteria**:
- ✅ Execution time: < 100ms (for 1000 rows)
- ✅ Planning time: < 10ms
- ✅ Index usage: Yes (verify with EXPLAIN ANALYZE)

### 5.4 Real-Time Updates

**Metric**: Time from clock in to dashboard update

**Actions**:
1. Open dashboard in Browser A
2. Clock in employee in Browser B (kiosk)
3. Measure time until dashboard updates

**Acceptance Criteria**:
- ✅ Update appears: < 2 seconds
- ✅ React Query refetch interval: 30 seconds
- ✅ Manual refresh: Instant

---

## 6. Translation Verification

### 6.1 Switch Language to Spanish

**Actions**:
1. Click language selector (top-right)
2. Select **"Español"**
3. Navigate through all DetailHub tabs

**Expected Results**:
- ✅ All UI text translates:
  - Dashboard titles
  - Button labels
  - Form fields
  - Toast messages
  - Table headers
  - Status badges
- ❌ **Zero hardcoded English text visible**

**Test Checklist**:
| Component | English | Spanish | Portuguese |
|-----------|---------|---------|------------|
| "Clock In" button | Clock In | Registrar Entrada | Registrar Entrada |
| "Employee" label | Employee | Empleado | Funcionário |
| "Total Hours" stat | Total Hours | Horas Totales | Horas Totais |
| Toast: "Clocked In" | Successfully clocked in | Entrada registrada | Entrada registrada |

### 6.2 Switch to Portuguese

**Actions**:
1. Select **"Português (Brasil)"**
2. Repeat navigation

**Expected Results**:
- ✅ All text in Portuguese (pt-BR)
- ✅ Date/time formats: Brazilian locale

### 6.3 Verify No Hardcoded Text

**Audit Script**:
```bash
# Run translation audit
node scripts/audit-translations.cjs

# Expected output:
# ✅ Coverage: 100%
# ✅ Missing keys: 0
# ✅ Hardcoded strings: 0
```

**Manual Check**:
1. Open browser DevTools > Console
2. Search for untranslated keys (appear as `detail_hub.some.key`)
3. Verify none exist

---

## 7. Sign-Off Checklist

### 7.1 Functional Testing

- [ ] **Flow 1**: Employee Management
  - [ ] Create employee with auto-generated number (EMP001)
  - [ ] Edit employee details
  - [ ] Search/filter employees
  - [ ] Assign PIN code
  - [ ] Verify employee in lists

- [ ] **Flow 2**: Schedule Management
  - [ ] Create shift
  - [ ] Assign kiosk
  - [ ] Set break policy (30 min)
  - [ ] Detect schedule conflicts
  - [ ] Verify calendar view

- [ ] **Flow 3**: Punch Clock Workflow ⭐⭐⭐
  - [ ] Clock In with photo capture
  - [ ] Photo uploads to Supabase Storage
  - [ ] Schedule validation works
  - [ ] Start Break with photo
  - [ ] End Break with duration calculation
  - [ ] Clock Out with hours calculation

- [ ] **Flow 4**: Photo Review/Approval
  - [ ] Pending reviews show employee names (NOT IDs)
  - [ ] Approve time entry
  - [ ] Reject time entry (deletes from DB)

- [ ] **Flow 5**: Live Dashboard
  - [ ] "Who's Working Now" shows names
  - [ ] Elapsed time counters update
  - [ ] Stats cards accurate

- [ ] **Flow 6**: Multi-Dealership Isolation ⭐⭐⭐
  - [ ] Dealership A employees invisible to B
  - [ ] Dealership B employees invisible to A
  - [ ] RLS policies enforced
  - [ ] Zero data leakage

- [ ] **Flow 7**: Break Policy Enforcement
  - [ ] 6+ hour shifts flagged
  - [ ] Break duration ≥ 30 min tracked

- [ ] **Flow 8**: Recent Activity
  - [ ] Shows employee names (NOT UUIDs)
  - [ ] Displays last 5 activities
  - [ ] Timestamps human-readable

### 7.2 Technical Validation

- [ ] **Database Integrity**
  - [ ] No console errors
  - [ ] No orphaned records (employee_id references valid)
  - [ ] All foreign keys intact
  - [ ] RLS policies active

- [ ] **Photos**
  - [ ] Upload successfully to Supabase Storage
  - [ ] Public URLs accessible
  - [ ] File naming convention: `clock_in_{timestamp}.jpg`
  - [ ] Storage path: `detail-hub-photos/{dealership_id}/{employee_id}/`

- [ ] **Hours Calculation**
  - [ ] `total_hours` = (clock_out - clock_in) - break
  - [ ] `regular_hours` ≤ 8.0
  - [ ] `overtime_hours` = total_hours - 8.0 (if > 8)
  - [ ] Calculations match manual verification

- [ ] **Performance**
  - [ ] Dashboard load: < 3s
  - [ ] Photo upload: < 5s
  - [ ] Query response: < 1s
  - [ ] Real-time updates: < 2s

### 7.3 Translation Coverage

- [ ] **English**: 100% complete
- [ ] **Spanish**: 100% complete
- [ ] **Portuguese**: 100% complete
- [ ] No hardcoded text in UI
- [ ] Translation audit passes: `npm run translation:audit`

### 7.4 Security & Compliance

- [ ] RLS policies prevent cross-dealership access
- [ ] Photo URLs publicly accessible (correct bucket policy)
- [ ] PIN codes encrypted/hashed (verify in DB)
- [ ] User permissions enforced (detail_hub module)
- [ ] Audit trail: `verified_by` and `verified_at` populated

### 7.5 Browser Compatibility

- [ ] Chrome (Desktop): All flows pass
- [ ] Firefox (Desktop): All flows pass
- [ ] Safari (macOS): All flows pass
- [ ] Chrome (Android): Photo capture works
- [ ] Safari (iOS): Photo capture works

---

## Final Sign-Off

**Tested By**: _______________________
**Date**: _______________________
**Environment**: [ ] Local Dev  [ ] Staging  [ ] Production
**Overall Status**: [ ] PASS  [ ] FAIL  [ ] CONDITIONAL PASS

**Blockers** (if any):
1.
2.
3.

**Approved for Production**: [ ] YES  [ ] NO

**Signature**: _______________________

---

## Appendix: Quick Reference

### Test User Credentials

| User | Email | Password | Dealership | Role |
|------|-------|----------|------------|------|
| System Admin | admin@detailhub.test | [set in Supabase] | All | system_admin |
| Manager A | manager-a@detailhub.test | [set in Supabase] | Premium Auto | dealer_admin |
| Manager B | manager-b@detailhub.test | [set in Supabase] | Elite Motors | dealer_admin |

### Kiosk URLs

| Kiosk | URL | Location |
|-------|-----|----------|
| KIOSK-001 | http://localhost:8080/kiosk?kiosk_id=KIOSK-001 | Front Desk |
| KIOSK-002 | http://localhost:8080/kiosk?kiosk_id=KIOSK-002 | Detail Shop |

### Database Shortcuts

```sql
-- Quick employee lookup
SELECT employee_number, first_name, last_name, status
FROM detail_hub_employees
WHERE dealership_id = [id]
ORDER BY employee_number;

-- Active time entries
SELECT e.employee_number, te.clock_in, te.status
FROM detail_hub_time_entries te
JOIN detail_hub_employees e ON te.employee_id = e.id
WHERE te.status = 'active';

-- Pending photo reviews
SELECT COUNT(*) FROM detail_hub_time_entries
WHERE requires_manual_verification = true
  AND verified_at IS NULL;
```

### Photo Storage Bucket

**Bucket Name**: `detail-hub-photos`
**Public Access**: Yes
**Path Structure**: `{dealership_id}/{employee_id}/{action}_{timestamp}.jpg`
**Example**: `1/emp123/clock_in_1731878400000.jpg`

---

**End of Document**
