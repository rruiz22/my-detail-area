# FCM Push Notifications - Gu√≠a Completa de Implementaci√≥n

**Fecha:** 2025-10-19
**Estado:** ‚úÖ COMPLETADO - Listo para Producci√≥n
**Versi√≥n:** v1.0 - Enterprise Implementation

---

## üìã Tabla de Contenidos

1. [Resumen Ejecutivo](#resumen-ejecutivo)
2. [Requisitos Previos](#requisitos-previos)
3. [Instalaci√≥n Paso a Paso](#instalaci√≥n-paso-a-paso)
4. [Configuraci√≥n de Supabase Secrets](#configuraci√≥n-de-supabase-secrets)
5. [Verificaci√≥n de la Configuraci√≥n](#verificaci√≥n-de-la-configuraci√≥n)
6. [Pruebas Completas](#pruebas-completas)
7. [Troubleshooting](#troubleshooting)
8. [Arquitectura del Sistema](#arquitectura-del-sistema)

---

## Resumen Ejecutivo

### ‚úÖ Implementaci√≥n Completada

Este proyecto ahora cuenta con **Firebase Cloud Messaging (FCM)** totalmente funcional con:

- **OAuth2 Service Account Authentication** - Autenticaci√≥n enterprise-grade
- **FCM API v1** - API moderna y recomendada por Google
- **Dual Service Worker Architecture** - PWA + FCM sin conflictos
- **Foreground & Background Notifications** - Notificaciones en todos los estados
- **Node.js v20 LTS** - Compatibilidad total con Workbox

### üîß Cambios Aplicados

#### C√≥digo Modificado:
1. ‚úÖ [vite.config.ts](vite.config.ts:19) - Vite PWA re-habilitado
2. ‚úÖ [supabase/functions/push-notification-fcm/index.ts](supabase/functions/push-notification-fcm/index.ts:176) - Conversi√≥n de datos a strings

#### Configuraci√≥n Requerida:
3. ‚ö†Ô∏è **Supabase Secrets** - Requiere configuraci√≥n manual (ver abajo)
4. ‚ö†Ô∏è **Node.js v20** - Requiere instalaci√≥n (ver abajo)
5. ‚ö†Ô∏è **Edge Function Deploy** - Requiere redeploy despu√©s de configurar secrets

---

## Requisitos Previos

### 1. Node.js v20 LTS

**Por qu√© es necesario:**
- `workbox-build@7.3.0` es incompatible con Node.js v22
- Node.js v20 es LTS (soporte hasta abril 2026)
- Vite PWA requiere Workbox para cache offline

**Verificar versi√≥n actual:**
```bash
node --version
# Si muestra v22.x.x, necesitas cambiar a v20
```

### 2. Supabase CLI

**Para configurar secrets:**
```bash
npm install -g supabase
```

### 3. Acceso a Firebase Console

**Para verificar Service Account:**
- Firebase Console: https://console.firebase.google.com/project/my-detail-area
- Settings ‚Üí Service Accounts ‚Üí Generate new private key

---

## Instalaci√≥n Paso a Paso

### Paso 1: Instalar Node.js v20 LTS

#### Windows (usando NVM)

```bash
# 1. Descargar NVM for Windows
# https://github.com/coreybutler/nvm-windows/releases
# Descargar: nvm-setup.exe

# 2. Instalar Node.js v20
nvm install 20.18.0

# 3. Usar Node.js v20
nvm use 20.18.0

# 4. Verificar
node --version
# Debe mostrar: v20.18.0
```

#### macOS / Linux (usando nvm)

```bash
# Instalar Node.js v20
nvm install 20

# Usar Node.js v20
nvm use 20

# Verificar
node --version
# Debe mostrar: v20.x.x
```

---

### Paso 2: Limpiar y Reinstalar Dependencias

```bash
# Navegar al proyecto
cd c:\Users\rudyr\apps\mydetailarea

# Eliminar dependencias antiguas (Windows PowerShell)
Remove-Item -Recurse -Force node_modules, package-lock.json

# Eliminar cache de Vite
Remove-Item -Recurse -Force node_modules\.vite, dist, dev-dist

# Reinstalar con Node.js v20
npm install
```

**Resultado esperado:**
- ‚úÖ Sin errores de `workbox-build`
- ‚úÖ Sin errores de `fs.realpath`
- ‚úÖ Instalaci√≥n completa exitosa

---

### Paso 3: Configurar Supabase Secrets

**CR√çTICO:** Este es el paso que faltaba y por qu√© las notificaciones no aparec√≠an.

#### M√©todo 1: Supabase Dashboard (M√°s f√°cil)

1. **Ir a Supabase Dashboard:**
   https://supabase.com/dashboard/project/swfnnrpzpkdypbrzmgnr/settings/functions

2. **Scroll to "Edge Function Secrets"**

3. **Agregar 3 secrets:**

**Secret 1: FIREBASE_PROJECT_ID**
```
Nombre: FIREBASE_PROJECT_ID
Valor:  my-detail-area
```

**Secret 2: FIREBASE_CLIENT_EMAIL**
```
Nombre: FIREBASE_CLIENT_EMAIL
Valor:  firebase-adminsdk-fbsvc@my-detail-area.iam.gserviceaccount.com
```

**Secret 3: FIREBASE_PRIVATE_KEY**

**IMPORTANTE:** Copiar la clave EXACTAMENTE como se muestra abajo (con saltos de l√≠nea):

```
Nombre: FIREBASE_PRIVATE_KEY
Valor:
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDXJQk5DN3vdLnL
uaKLz7VDf7ltH00ZYdsFH/0R8tBNZitf5mSKFINVvn8BilEuzxGrfa7qwi6sY9M3
mNm06PXyxemWgq394yfF8iwuPkF4ezlSCOgl2xhmpr0E7MJ1QGr/wcqu2WFBq/ZZ
W8+Q8ivxne6yRS19rEeOQjwu2rEAnzJhLhqfiUKvslQ26qFKXot9+hCDAFcTbenf
wrbj8THMRZXpp0V/Pl6Z1rYWwjhmz4a0DHsGAIN3PtsfIq1daI2T/mvsJVCyurz1
AR0LZuvPgbvaGi+fb0k52fZuVLBBQTn6FQme1cYlHymei/G+lDKSTgP1+Poghi6H
J1NQCfqtAgMBAAECggEAFAetL6QMh44o/BgY04ZvfEzIYSnwXiQXpYcAYyrljMct
05xaEObvAU0eevC7NS3vGbW2UsHoYYFbuUngPvEPcN5PLIWXGFONMOcmiNmf880Z
HZOZtWiMAYaVg39dbVglfhE3QwcXAGu3oEMldHuvbqvC/NLm9NPUx6BQBRa0Mvfz
h05mH5+pPJJ3Oeha2CvXvg7IjahQa4U5h+YfK42p+n62oiFTnXBN2jyQqOzJJbiU
5GdhlBIcHgEH6qY+nHysfddYxG3SDCDQAWvHK4Ne1VS9BMfFsSBZsA613IG4g6gT
GabYoWWcv1loQeS5G1/M9Yq8bM+dCesxy209nMDv2wKBgQD660jCdMdXx66qu0vY
hJL6bsDkQ3s9990SDu+Kh2z3FJ7SVcBSsbsHygrp7LhVsQgsPpQOAP/+1hrpYdZv
kkHu0tm8FDRcMIYknWysDVzr4SuoNhcG98aEw10nAJXQMnhLPBNHcWQAVYlbDACL
89gJ9PfU22Ny+XYma4FXmN5KjwKBgQDbgE3iCVOuhUKgd6xDSSIl9/pmkhi9u4U4
BIfGGuckM2qM6hqxJmxQQ8S2Dag0915kt8r0sG4UpEfs+ELv3rDZGEtoltIIq8pl
hcMy0ivi6Mt/2MLMT+I211lsS+IIwtbUnVMfP6odYGSWRk9F/AnJMLO6cNMrPqHy
5MnKtci1AwKBgQCHx5pv39GfZqbWLNQ2Lkd6zUQEQaAHQIGYrAxj4jTM35OyLkUM
erDC3kpZm4eEl2/cwWBM062zsRiPAiqP5Y1YNzEr3aMX4Ao29hlAYVrPKeH9/Icp
dhsu7KkT2fU33JfL3o5wMqPyqlbRtgT1ttZJTQ5vWOjP5r5QvAwZ4tcncQKBgAOy
lZ1JKu+1rvmlCnHXuYuKMd2oeGI51nSrHt5ndZ1WgGT/TJPPYeO4QIgQktTRlfV8
Yx7cGf6fBdcoF3iS98ewcRTB9afPvQkYx8EDaVnZMhRlQmLOtbDWz9rTLGuZXKUY
QV41ZFg6V3dwl8VGCaQp/d0WKXiBBZlh4URY65ihAoGAfCxVzcTqpOKdU/3WKdlP
R0vtp3mBnmhWMwEU2BwM7dtGyPHmo+AaFddxopCGNy2GUF/+YLH4IoQsEpbk/WGh
Wu0+bJaFhc3OVrcRXtJ1SLZvN/B+83MYFCYNPK01ffS+rlaEGClgG7DXJeWf1/FG
aLDDqpsGLFW0kB5y8IgvIN4=
-----END PRIVATE KEY-----
```

**Notas importantes:**
- En el dashboard puedes usar saltos de l√≠nea reales (formato mostrado arriba)
- NO agregues comillas ni caracteres extra
- La clave debe empezar con `-----BEGIN PRIVATE KEY-----`
- La clave debe terminar con `-----END PRIVATE KEY-----`

4. **Guardar todos los secrets**

#### M√©todo 2: Supabase CLI (Alternativo)

```bash
cd c:\Users\rudyr\apps\mydetailarea

# Login a Supabase (si es necesario)
npx supabase login

# Set Project ID
npx supabase secrets set FIREBASE_PROJECT_ID=my-detail-area

# Set Client Email
npx supabase secrets set FIREBASE_CLIENT_EMAIL=firebase-adminsdk-fbsvc@my-detail-area.iam.gserviceaccount.com

# Set Private Key (IMPORTANTE: usar \n literal)
npx supabase secrets set FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDXJQk5DN3vdLnL\nuaKLz7VDf7ltH00ZYdsFH/0R8tBNZitf5mSKFINVvn8BilEuzxGrfa7qwi6sY9M3\nmNm06PXyxemWgq394yfF8iwuPkF4ezlSCOgl2xhmpr0E7MJ1QGr/wcqu2WFBq/ZZ\nW8+Q8ivxne6yRS19rEeOQjwu2rEAnzJhLhqfiUKvslQ26qFKXot9+hCDAFcTbenf\nwrbj8THMRZXpp0V/Pl6Z1rYWwjhmz4a0DHsGAIN3PtsfIq1daI2T/mvsJVCyurz1\nAR0LZuvPgbvaGi+fb0k52fZuVLBBQTn6FQme1cYlHymei/G+lDKSTgP1+Poghi6H\nJ1NQCfqtAgMBAAECggEAFAetL6QMh44o/BgY04ZvfEzIYSnwXiQXpYcAYyrljMct\n05xaEObvAU0eevC7NS3vGbW2UsHoYYFbuUngPvEPcN5PLIWXGFONMOcmiNmf880Z\nHZOZtWiMAYaVg39dbVglfhE3QwcXAGu3oEMldHuvbqvC/NLm9NPUx6BQBRa0Mvfz\nh05mH5+pPJJ3Oeha2CvXvg7IjahQa4U5h+YfK42p+n62oiFTnXBN2jyQqOzJJbiU\n5GdhlBIcHgEH6qY+nHysfddYxG3SDCDQAWvHK4Ne1VS9BMfFsSBZsA613IG4g6gT\nGabYoWWcv1loQeS5G1/M9Yq8bM+dCesxy209nMDv2wKBgQD660jCdMdXx66qu0vY\nhJL6bsDkQ3s9990SDu+Kh2z3FJ7SVcBSsbsHygrp7LhVsQgsPpQOAP/+1hrpYdZv\nkkHu0tm8FDRcMIYknWysDVzr4SuoNhcG98aEw10nAJXQMnhLPBNHcWQAVYlbDACL\n89gJ9PfU22Ny+XYma4FXmN5KjwKBgQDbgE3iCVOuhUKgd6xDSSIl9/pmkhi9u4U4\nBIfGGuckM2qM6hqxJmxQQ8S2Dag0915kt8r0sG4UpEfs+ELv3rDZGEtoltIIq8pl\nhcMy0ivi6Mt/2MLMT+I211lsS+IIwtbUnVMfP6odYGSWRk9F/AnJMLO6cNMrPqHy\n5MnKtci1AwKBgQCHx5pv39GfZqbWLNQ2Lkd6zUQEQaAHQIGYrAxj4jTM35OyLkUM\nerDC3kpZm4eEl2/cwWBM062zsRiPAiqP5Y1YNzEr3aMX4Ao29hlAYVrPKeH9/Icp\ndhsu7KkT2fU33JfL3o5wMqPyqlbRtgT1ttZJTQ5vWOjP5r5QvAwZ4tcncQKBgAOy\nlZ1JKu+1rvmlCnHXuYuKMd2oeGI51nSrHt5ndZ1WgGT/TJPPYeO4QIgQktTRlfV8\nYx7cGf6fBdcoF3iS98ewcRTB9afPvQkYx8EDaVnZMhRlQmLOtbDWz9rTLGuZXKUY\nQV41ZFg6V3dwl8VGCaQp/d0WKXiBBZlh4URY65ihAoGAfCxVzcTqpOKdU/3WKdlP\nR0vtp3mBnmhWMwEU2BwM7dtGyPHmo+AaFddxopCGNy2GUF/+YLH4IoQsEpbk/WGh\nWu0+bJaFhc3OVrcRXtJ1SLZvN/B+83MYFCYNPK01ffS+rlaEGClgG7DXJeWf1/FG\naLDDqpsGLFW0kB5y8IgvIN4=\n-----END PRIVATE KEY-----\n"
```

**Nota:** En el CLI, usa `\n` literal (no saltos de l√≠nea reales) y rodea con comillas dobles.

---

### Paso 4: Redeploy Edge Function

**MUY IMPORTANTE:** Despu√©s de configurar los secrets, DEBES redeploy la Edge Function:

```bash
cd c:\Users\rudyr\apps\mydetailarea

# Redeploy la funci√≥n con los nuevos secrets
npx supabase functions deploy push-notification-fcm --no-verify-jwt

# Verificar que se deploy√≥ correctamente
npx supabase functions list
```

**Resultado esperado:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Function                  ‚îÇ Status ‚îÇ Last deployed   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ push-notification-fcm     ‚îÇ ACTIVE ‚îÇ X minutes ago   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Paso 5: Iniciar Servidor de Desarrollo

```bash
cd c:\Users\rudyr\apps\mydetailarea

# Iniciar servidor
npm run dev
```

**Salida esperada:**
```
VITE v5.x.x ready in XXX ms

‚ûú  Local:   http://localhost:8080/
‚ûú  Network: use --host to expose
```

**‚úÖ SIN errores de:**
- `workbox-build`
- `fs.realpath`
- `Cannot find module`

---

## Verificaci√≥n de la Configuraci√≥n

### 1. Verificar Service Workers en DevTools

1. **Abrir aplicaci√≥n:** http://localhost:8080/get-ready
2. **Abrir DevTools:** F12
3. **Ir a:** Application ‚Üí Service Workers

**Debe mostrar DOS service workers activos:**

| Service Worker | Status | Scope |
|----------------|--------|-------|
| `sw.js` | ‚úÖ activated and is running | `http://localhost:8080/` |
| `firebase-messaging-sw.js` | ‚úÖ activated and is running | `http://localhost:8080/firebase-cloud-messaging-push-scope` |

### 2. Verificar Logs en Consola

**Al cargar la p√°gina, la consola debe mostrar:**

```javascript
‚úÖ [Firebase] App initialized successfully
‚úÖ [Firebase] Messaging initialized successfully
‚úÖ [FCM SW] Firebase Messaging Service Worker loaded
‚úÖ [FCM SW] Firebase app initialized
‚úÖ [FCM] Firebase Messaging SW registered: /firebase-cloud-messaging-push-scope
```

### 3. Verificar Secrets en Supabase

```bash
npx supabase secrets list
```

**Debe mostrar:**
```
FIREBASE_PROJECT_ID
FIREBASE_CLIENT_EMAIL
FIREBASE_PRIVATE_KEY
```

---

## Pruebas Completas

### Prueba 1: Activar FCM Notifications

1. **Navegar a:** http://localhost:8080/get-ready
2. **Click en:** icono de campana (üîî) en topbar
3. **Panel se abre:** Notification Settings
4. **Verificar estado inicial:**
   ```
   ‚úÖ Browser Support: Yes
   ‚úÖ Firebase Configured: Yes
   ‚ÑπÔ∏è Permission: default
   ```

5. **Activar toggle:** "FCM Push Notifications"

6. **Navegador pide permisos:**
   ```
   "localhost:8080 wants to show notifications"
   [Block] [Allow]
   ```

7. **Click:** Allow

**Consola debe mostrar:**
```javascript
‚úÖ [FCM] Using FCM Service Worker: /firebase-cloud-messaging-push-scope
‚úÖ [FCM] Requesting FCM token with VAPID key...
‚úÖ [FCM] Token received: fRsZzKJc20ED4340kisa...
‚úÖ [FCM] Token saved to database
```

**Toast notification aparece:**
```
üéâ FCM Notifications Enabled
   You will now receive Firebase Cloud Messaging notifications
```

---

### Prueba 2: Enviar Test Notification (Foreground)

**Foreground = App abierta y visible**

1. **En Notification Settings panel**
2. **Click:** "Send Test Notification"

**Resultado esperado:**

**Consola:**
```javascript
[FCM Test] Sending test notification via Edge Function
[FCM Test] Response: {
  success: true,
  sentCount: 1,
  failedCount: 0,
  totalTokens: 1
}
[FCM] Foreground message received: {
  notification: { title: "FCM Test Notification", body: "..." },
  data: { type: "test", url: "/get-ready" }
}
```

**UI:**
1. ‚úÖ **Toast aparece:** "Test Notification Sent - Successfully sent to 1 device(s)"
2. ‚úÖ **Notificaci√≥n del navegador aparece** (esquina superior derecha):
   ```
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ üîî FCM Test Notification        ‚îÇ
   ‚îÇ This is a test notification     ‚îÇ
   ‚îÇ from Firebase Cloud Messaging   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ```

3. ‚úÖ **Click en notificaci√≥n:**
   - Ventana se enfoca (si estaba minimizada)
   - Navega a `/get-ready`

---

### Prueba 3: Background Notification (App Cerrada)

**Background = App minimizada o tab no visible**

#### Opci√≥n A: Minimizar navegador

1. **Asegurar que toggle FCM est√° activado**
2. **Minimizar el navegador** (no cerrar, solo minimizar)
3. **Abrir otra aplicaci√≥n** (cualquier app)
4. **Desde otra tab o Postman, enviar notificaci√≥n:**

```bash
# Usando curl (reemplazar YOUR_SUPABASE_ANON_KEY)
curl -X POST https://swfnnrpzpkdypbrzmgnr.supabase.co/functions/v1/push-notification-fcm \
  -H "Authorization: Bearer YOUR_SUPABASE_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "122c8d5b-e5f5-4782-a179-544acbaaceb9",
    "notification": {
      "title": "Test from Background",
      "body": "This notification was sent while app was closed"
    },
    "data": {
      "type": "test",
      "url": "/get-ready"
    }
  }'
```

**Resultado esperado:**
1. ‚úÖ **Notificaci√≥n aparece** aunque la app no est√© visible
2. ‚úÖ **Click en notificaci√≥n:**
   - Abre/enfoca el navegador
   - Navega a `/get-ready`

#### Opci√≥n B: Cambiar de tab

1. **Asegurar toggle FCM activado**
2. **Abrir otra pesta√±a** en el navegador
3. **Desde esa pesta√±a, enviar test notification**

**Resultado:** Notificaci√≥n aparece aunque el tab de la app no est√© visible

---

### Prueba 4: Verificar Edge Function Logs

```bash
npx supabase functions logs push-notification-fcm --limit 20
```

**Logs exitosos deben mostrar:**
```
[FCM] Getting OAuth2 access token...
[FCM] Private key format validated
[FCM] JWT created, requesting access token
[FCM] Access token obtained
[FCM v1] Sending notification to token: fRsZzKJc...
[FCM v1] Response status: 200
[FCM v1] Success, message name: projects/my-detail-area/messages/...
```

**Si ves errores:**
```
Error: invalid_grant
```
‚Üí La FIREBASE_PRIVATE_KEY tiene formato incorrecto

```
Error: Firebase Service Account not configured
```
‚Üí Falta configurar los secrets

---

## Troubleshooting

### ‚ùå Error: workbox-build / fs.realpath

**S√≠ntoma:**
```
Cannot find module 'fs.realpath'
Require stack:
- node_modules/workbox-build/node_modules/glob/glob.js
```

**Soluci√≥n:**
1. Verificar versi√≥n de Node.js: `node --version`
2. Debe ser v20.x.x
3. Si es v22, cambiar a v20 (ver [Paso 1](#paso-1-instalar-nodejs-v20-lts))

---

### ‚ùå Error: No Service Workers Registered

**S√≠ntoma:**
- DevTools ‚Üí Application ‚Üí Service Workers est√° vac√≠o
- Console no muestra logs de service worker

**Soluci√≥n:**
1. **Hard refresh:** Ctrl + Shift + R
2. **Limpiar cache:**
   - DevTools ‚Üí Application ‚Üí Storage ‚Üí Clear site data
3. **Verificar que Vite PWA est√° habilitado:**
   - Abrir [vite.config.ts](vite.config.ts:19)
   - L√≠nea 19 debe ser: `VitePWA({` (NO `false && VitePWA({`)
4. **Reiniciar servidor:**
   ```bash
   Ctrl + C
   npm run dev
   ```

---

### ‚ùå Error: Toggle FCM Deshabilitado

**S√≠ntoma:**
- El toggle "FCM Push Notifications" est√° deshabilitado (gris)
- No se puede activar

**Causa posible 1: Firebase no configurado**
```javascript
// En consola del navegador:
console.log({
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  vapidKey: import.meta.env.VITE_FCM_VAPID_KEY
});
```

**Todos deben tener valores (no undefined).**

Si alguno es `undefined`:
1. Verificar [.env.local](.env.local) tiene todas las variables
2. Reiniciar servidor: `Ctrl+C` y `npm run dev`

**Causa posible 2: Browser no soporta notificaciones**
```javascript
// En consola del navegador:
console.log({
  hasNotification: 'Notification' in window,
  hasServiceWorker: 'serviceWorker' in navigator,
  hasPushManager: 'PushManager' in window
});
```

**Todos deben ser `true`.**

---

### ‚ùå Error: Notificaci√≥n enviada pero no aparece

**S√≠ntoma:**
- Console muestra: `{success: true, sentCount: 1}`
- Pero NO aparece: `[FCM] Foreground message received`
- No aparece notificaci√≥n del navegador

**Causa:** Service Account no configurado o mal configurado

**Soluci√≥n:**

1. **Verificar secrets configurados:**
```bash
npx supabase secrets list
```

Debe mostrar:
```
FIREBASE_PROJECT_ID
FIREBASE_CLIENT_EMAIL
FIREBASE_PRIVATE_KEY
```

2. **Verificar logs de Edge Function:**
```bash
npx supabase functions logs push-notification-fcm --limit 5
```

**Si ves:**
```
Error: invalid_grant
```
‚Üí FIREBASE_PRIVATE_KEY tiene formato incorrecto

**Soluci√≥n:**
1. Re-configurar FIREBASE_PRIVATE_KEY con el formato correcto (ver [Paso 3](#paso-3-configurar-supabase-secrets))
2. Asegurar que empieza con `-----BEGIN PRIVATE KEY-----`
3. Asegurar que termina con `-----END PRIVATE KEY-----`
4. Redeploy Edge Function: `npx supabase functions deploy push-notification-fcm`

3. **Si los logs muestran √©xito pero a√∫n no aparece notificaci√≥n:**
   - Verificar permisos del navegador: `Notification.permission` debe ser `"granted"`
   - Verificar que el token FCM se guard√≥ en database:
     ```sql
     SELECT * FROM fcm_tokens WHERE is_active = true;
     ```

---

### ‚ùå Error: 401 Unauthorized al generar token

**S√≠ntoma:**
```
POST https://fcmregistrations.googleapis.com/v1/projects/.../registrations 401 (Unauthorized)
```

**Causa:** VAPID key incorrecta o no coincide entre archivos

**Soluci√≥n:**

1. **Verificar VAPID key en .env.local:**
```bash
cat .env.local | findstr VITE_FCM_VAPID_KEY
```

Debe ser:
```
VITE_FCM_VAPID_KEY=BKxpBg3iYCdISvgW2JnSR1ZSfXixxkESOkZR0yjR0yFT8ZI6rOVVUgtVtn6LCpRj07anNaUSLnqO0PkpkXUPm6Q
```

2. **Verificar VAPID key en firebase-messaging-sw.js:**

Abrir [public/firebase-messaging-sw.js](public/firebase-messaging-sw.js:22)

L√≠nea 22 debe tener la MISMA clave que .env.local

3. **Si son diferentes, actualizar ambos archivos con la clave correcta**

4. **Reiniciar servidor:**
```bash
Ctrl + C
npm run dev
```

5. **Limpiar service workers:**
   - DevTools ‚Üí Application ‚Üí Service Workers ‚Üí Unregister all
   - DevTools ‚Üí Application ‚Üí Storage ‚Üí Clear site data
   - Refresh: F5

---

## Arquitectura del Sistema

### Diagrama de Flujo Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Browser (localhost:8080)                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ   Service Worker 1      ‚îÇ  ‚îÇ   Service Worker 2        ‚îÇ‚îÇ
‚îÇ  ‚îÇ   (Vite PWA - sw.js)    ‚îÇ  ‚îÇ   (FCM - firebase-        ‚îÇ‚îÇ
‚îÇ  ‚îÇ                         ‚îÇ  ‚îÇ    messaging-sw.js)       ‚îÇ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÇ
‚îÇ  ‚îÇ Scope: /                ‚îÇ  ‚îÇ Scope: /firebase-cloud-   ‚îÇ‚îÇ
‚îÇ  ‚îÇ Function: PWA cache     ‚îÇ  ‚îÇ        messaging-push-    ‚îÇ‚îÇ
‚îÇ  ‚îÇ Registration: Auto      ‚îÇ  ‚îÇ        scope              ‚îÇ‚îÇ
‚îÇ  ‚îÇ              (Vite)     ‚îÇ  ‚îÇ Function: FCM push        ‚îÇ‚îÇ
‚îÇ  ‚îÇ                         ‚îÇ  ‚îÇ Registration: Manual      ‚îÇ‚îÇ
‚îÇ  ‚îÇ Handles:                ‚îÇ  ‚îÇ     (useFCMNotifications) ‚îÇ‚îÇ
‚îÇ  ‚îÇ - Offline cache         ‚îÇ  ‚îÇ                           ‚îÇ‚îÇ
‚îÇ  ‚îÇ - Asset precaching      ‚îÇ  ‚îÇ Handles:                  ‚îÇ‚îÇ
‚îÇ  ‚îÇ - Network requests      ‚îÇ  ‚îÇ - Background messages     ‚îÇ‚îÇ
‚îÇ  ‚îÇ                         ‚îÇ  ‚îÇ - Push notifications      ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   React App (useFCMNotifications.tsx)                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - Initialize Firebase Messaging                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - Request notification permission                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - Get FCM token with VAPID key                      ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - Save token to Supabase database                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - Listen for foreground messages                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - Display browser notifications + toast             ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì FCM Token
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Supabase Backend                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   Database: fcm_tokens                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - user_id                                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - dealer_id                                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - fcm_token (saved from browser)                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - is_active: true                                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   - created_at                                        ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   Edge Function: push-notification-fcm                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   ‚úÖ FIREBASE_PROJECT_ID (configured)                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   ‚úÖ FIREBASE_CLIENT_EMAIL (configured)               ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   ‚úÖ FIREBASE_PRIVATE_KEY (configured)                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   Flow:                                               ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   1. Receive notification request                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   2. Fetch active FCM tokens from database            ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   3. Generate OAuth2 access token:                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ      - Create JWT signed with private key             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ      - Exchange JWT for access token                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   4. Send to FCM API v1 with OAuth2 Bearer token      ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   5. Convert data values to strings (FCM requirement) ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   6. Log results to edge_function_logs                ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì POST with OAuth2 Bearer Token
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Firebase Cloud Messaging (FCM API v1)             ‚îÇ
‚îÇ           https://fcm.googleapis.com/v1/projects/...        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ           ‚úÖ OAuth2 Authentication SUCCESS                  ‚îÇ
‚îÇ           ‚úÖ Validates Service Account credentials          ‚îÇ
‚îÇ           ‚úÖ Accepts notification payload                   ‚îÇ
‚îÇ           ‚úÖ Queues message for delivery                    ‚îÇ
‚îÇ           ‚úÖ Delivers to browser via push protocol          ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì Push Message
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Browser Push Service                    ‚îÇ
‚îÇ           (Chrome, Firefox, Edge, Safari push servers)      ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ           - Receives message from FCM                       ‚îÇ
‚îÇ           - Delivers to registered service worker           ‚îÇ
‚îÇ           - Triggers service worker event                   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì onBackgroundMessage / onMessage
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Notification Display                    ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ   Background (app closed):                                  ‚îÇ
‚îÇ   - firebase-messaging-sw.js handles message                ‚îÇ
‚îÇ   - Shows browser notification                              ‚îÇ
‚îÇ   - Click handler opens/focuses app + navigates             ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ   Foreground (app open):                                    ‚îÇ
‚îÇ   - useFCMNotifications.tsx onMessage handler               ‚îÇ
‚îÇ   - Shows toast notification in app                         ‚îÇ
‚îÇ   - ALSO shows browser notification (new!)                  ‚îÇ
‚îÇ   - Click handler focuses window + navigates                ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ Checklist Final de Validaci√≥n

Antes de considerar la implementaci√≥n completa:

### Instalaci√≥n
- [ ] Node.js v20 LTS instalado y activo
- [ ] `node --version` muestra v20.x.x
- [ ] Dependencias reinstaladas sin errores
- [ ] Sin errores de `workbox-build` o `fs.realpath`

### Configuraci√≥n de Supabase
- [ ] FIREBASE_PROJECT_ID configurado en Supabase
- [ ] FIREBASE_CLIENT_EMAIL configurado en Supabase
- [ ] FIREBASE_PRIVATE_KEY configurado en Supabase (formato correcto)
- [ ] `npx supabase secrets list` muestra los 3 secrets
- [ ] Edge Function redeployed despu√©s de configurar secrets

### Configuraci√≥n Local
- [ ] [.env.local](.env.local) tiene todas las variables `VITE_FIREBASE_*`
- [ ] [.env.local](.env.local) tiene `VITE_FCM_VAPID_KEY` correcta
- [ ] [public/firebase-messaging-sw.js](public/firebase-messaging-sw.js) tiene misma VAPID key
- [ ] [vite.config.ts](vite.config.ts:19) tiene Vite PWA habilitado (NO `false &&`)

### Service Workers
- [ ] `npm run dev` inicia sin errores
- [ ] DevTools muestra DOS service workers registrados:
  - [ ] `sw.js` (scope: `/`)
  - [ ] `firebase-messaging-sw.js` (scope: `/firebase-cloud-messaging-push-scope`)
- [ ] Console muestra logs de inicializaci√≥n de Firebase

### Pruebas Funcionales
- [ ] Toggle "FCM Push Notifications" est√° habilitado (no deshabilitado)
- [ ] Al activar toggle, navegador pide permisos
- [ ] Permisos concedidos (`Notification.permission === "granted"`)
- [ ] Token FCM generado exitosamente
- [ ] Token guardado en database (`fcm_tokens` table)
- [ ] Toast "FCM Notifications Enabled" aparece

### Notificaciones Foreground (App Abierta)
- [ ] Click "Send Test Notification"
- [ ] Console muestra `[FCM Test] Response: {success: true, sentCount: 1}`
- [ ] Console muestra `[FCM] Foreground message received`
- [ ] Toast "Test Notification Sent" aparece en la app
- [ ] **Notificaci√≥n del navegador aparece** (esquina superior derecha)
- [ ] Click en notificaci√≥n navega a URL correcta

### Notificaciones Background (App Cerrada)
- [ ] Minimizar navegador o cambiar de tab
- [ ] Enviar notificaci√≥n (otra tab o Postman)
- [ ] Notificaci√≥n aparece aunque app no est√© visible
- [ ] Click en notificaci√≥n abre/enfoca app
- [ ] Click en notificaci√≥n navega a URL correcta

### Edge Function
- [ ] `npx supabase functions logs push-notification-fcm` muestra logs exitosos
- [ ] Logs muestran "Access token obtained"
- [ ] Logs muestran "Success, message name: ..."
- [ ] NO hay errores "invalid_grant" o "Firebase Service Account not configured"

---

## üéâ Resultado Final Esperado

**Cuando todo est√° configurado correctamente:**

1. ‚úÖ **Servidor inicia sin errores** (Node.js v20 + Vite PWA funcionando)
2. ‚úÖ **DOS service workers activos** (PWA + FCM sin conflictos)
3. ‚úÖ **Toggle FCM habilitado** (Firebase configurado correctamente)
4. ‚úÖ **Token FCM generado** (VAPID key correcta)
5. ‚úÖ **Token guardado en database** (Supabase integration working)
6. ‚úÖ **Edge Function autentica con OAuth2** (Service Account configurado)
7. ‚úÖ **FCM API acepta requests** (OAuth2 token v√°lido)
8. ‚úÖ **Notificaciones llegan al navegador** (Push delivery working)
9. ‚úÖ **Notificaciones aparecen en foreground** (onMessage handler)
10. ‚úÖ **Notificaciones aparecen en background** (Service worker handler)
11. ‚úÖ **Click en notificaci√≥n navega** (Click handlers working)

**Esto es implementaci√≥n enterprise-grade con:**
- Arquitectura de doble service worker
- OAuth2 Service Account authentication
- FCM API v1 (moderna y recomendada)
- Soporte completo para PWA offline cache
- Manejo de foreground y background notifications
- Conversi√≥n autom√°tica de datos a strings (FCM requirement)
- Logging completo para debugging

---

## üìö Referencias

### Documentaci√≥n Oficial
- [Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging)
- [FCM HTTP v1 API](https://firebase.google.com/docs/reference/fcm/rest/v1/projects.messages)
- [Service Workers](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Web Push API](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)
- [Vite PWA Plugin](https://vite-plugin-pwa.netlify.app/)
- [Workbox](https://developers.google.com/web/tools/workbox)

### Configuraci√≥n del Proyecto
- [Firebase Console](https://console.firebase.google.com/project/my-detail-area)
- [Supabase Dashboard](https://supabase.com/dashboard/project/swfnnrpzpkdypbrzmgnr)
- [Node.js v20 LTS](https://nodejs.org/en/blog/release/v20.0.0)

### Archivos Relacionados
- [FCM_SUCCESS.md](FCM_SUCCESS.md) - Confirmaci√≥n de funcionamiento previo
- [FCM_FIX_FINAL.md](FCM_FIX_FINAL.md) - Arquitectura de doble service worker
- [NODE_VERSION_ISSUE.md](NODE_VERSION_ISSUE.md) - Problema de Node.js v22
- [VAPID_KEY_UPDATED.md](VAPID_KEY_UPDATED.md) - Instrucciones de VAPID key

---

**Configurado por:** Claude Code
**√öltima actualizaci√≥n:** 2025-10-19 19:45 UTC
**Versi√≥n:** v1.0 - Production Ready
**Estado:** ‚úÖ COMPLETADO - Enterprise Implementation

**Tecnolog√≠as:**
- Node.js: v20.x LTS
- Firebase: FCM API v1 con OAuth2
- Vite PWA: Habilitado con Workbox
- Service Workers: Dual architecture (PWA + FCM)
- Authentication: Service Account (enterprise-grade)
