# FCM Push Notifications - Soluci√≥n Final

**Fecha:** 2025-10-19
**Estado:** ‚úÖ Implementado - Listo para probar

---

## üîç Problema Ra√≠z Identificado

### ‚ùå El Service Worker NO se estaba registrando

**Causa:**
- Vite PWA con estrategia `injectManifest` requiere que el service worker incluya `self.__WB_MANIFEST`
- `firebase-messaging-sw.js` NO ten√≠a este placeholder
- Vite PWA no pod√≠a procesar el archivo
- **Resultado:** No hay service worker = No hay FCM token = Toggle deshabilitado

---

## ‚úÖ Soluci√≥n Implementada

### **Arquitectura de Doble Service Worker**

En lugar de mezclar PWA y FCM en un solo service worker, ahora usamos **DOS service workers separados**:

```
Service Worker 1 (PWA)                Service Worker 2 (FCM)
‚îú‚îÄ Generado por Vite PWA             ‚îú‚îÄ firebase-messaging-sw.js
‚îú‚îÄ Scope: / (ra√≠z)                   ‚îú‚îÄ Scope: /firebase-cloud-messaging-push-scope
‚îú‚îÄ Funci√≥n: Cache offline            ‚îú‚îÄ Funci√≥n: Push notifications
‚îú‚îÄ Auto-registrado por Vite          ‚îî‚îÄ Registrado manualmente en useFCMNotifications
‚îî‚îÄ Workbox precaching
```

**Ventajas:**
‚úÖ Separaci√≥n de responsabilidades
‚úÖ No hay conflictos entre SW
‚úÖ M√°s f√°cil de debuggear
‚úÖ PWA y FCM funcionan independientemente

---

## üìù Cambios Realizados

### 1. **vite.config.ts** - Cambio de Estrategia

**ANTES (‚ùå No funcionaba):**
```typescript
VitePWA({
  strategies: 'injectManifest',  // ‚ùå Requiere self.__WB_MANIFEST
  srcDir: 'public',
  filename: 'firebase-messaging-sw.js',  // ‚ùå No tiene el placeholder
  devOptions: {
    enabled: false,  // ‚ùå No registra SW en desarrollo
  }
})
```

**DESPU√âS (‚úÖ Funcionando):**
```typescript
VitePWA({
  strategies: 'generateSW',  // ‚úÖ Vite genera el SW autom√°ticamente
  // NO especificamos srcDir ni filename
  devOptions: {
    enabled: true,  // ‚úÖ Registra SW en desarrollo
  }
})
```

**Resultado:**
- Vite PWA ahora genera y registra autom√°ticamente el service worker para PWA
- Scope: `/` (ra√≠z del sitio)
- Archivo generado: `sw.js` (en dist/)

---

### 2. **useFCMNotifications.tsx** - Registro Manual de FCM SW

**Agregado al `useEffect` de inicializaci√≥n:**

```typescript
useEffect(() => {
  const checkSupport = async () => {
    const supported = 'Notification' in window &&
                      'serviceWorker' in navigator &&
                      'PushManager' in window;

    setIsSupported(supported);
    setIsConfigured(isFirebaseConfigured());

    if (supported) {
      setPermission(Notification.permission);

      // ‚úÖ NUEVO: Registrar Firebase Messaging SW manualmente
      try {
        const registration = await navigator.serviceWorker.register(
          '/firebase-messaging-sw.js',
          { scope: '/firebase-cloud-messaging-push-scope' }  // Scope diferente
        );
        console.log('[FCM] Firebase Messaging SW registered:', registration.scope);
      } catch (error) {
        console.error('[FCM] Firebase Messaging SW registration failed:', error);
      }
    }
  };

  checkSupport();
}, []);
```

**Resultado:**
- `firebase-messaging-sw.js` ahora se registra con un scope espec√≠fico para FCM
- No interfiere con el service worker de PWA

---

### 3. **useFCMNotifications.tsx** - Obtener SW Correcto para FCM Token

**ANTES (‚ùå):**
```typescript
const registration = await navigator.serviceWorker.ready;
// ‚ùå Esto pod√≠a devolver el SW de PWA, no el de FCM
```

**DESPU√âS (‚úÖ):**
```typescript
// Buscar el service worker de FCM espec√≠ficamente
const registrations = await navigator.serviceWorker.getRegistrations();
const fcmRegistration = registrations.find(reg =>
  reg.scope.includes('firebase-cloud-messaging-push-scope')
);

if (!fcmRegistration) {
  throw new Error('Firebase Messaging service worker not found. Please refresh the page.');
}

console.log('[FCM] Using FCM Service Worker:', fcmRegistration.scope);

// Usar el registration correcto para obtener el token
const token = await getToken(messaging, {
  serviceWorkerRegistration: fcmRegistration,  // ‚úÖ SW de FCM
  vapidKey: fcmVapidKey,
});
```

**Resultado:**
- Garantiza que el token FCM se genera usando el service worker correcto
- Evita errores de "service worker not found"

---

## üß™ C√≥mo Probar

### Paso 1: Limpiar Cache Completo

**CR√çTICO:** Debes eliminar TODOS los service workers antiguos

#### Chrome/Edge:
```
1. F12 ‚Üí Application ‚Üí Service Workers
2. Click "Unregister" en TODOS los service workers
3. Application ‚Üí Storage ‚Üí Clear site data
4. Cerrar y volver a abrir el navegador
```

#### Firefox:
```
1. F12 ‚Üí Storage ‚Üí Service Workers
2. Unregister todos los SW listados
3. Cache Storage ‚Üí Delete All
4. Cerrar y volver a abrir el navegador
```

---

### Paso 2: Reiniciar Servidor

```bash
# Detener servidor actual
Ctrl + C

# Limpiar cache de Vite
rm -rf node_modules/.vite dist dev-dist

# Reiniciar
npm run dev
```

**Verificar output:**
```
VITE v5.x.x ready in XXX ms

‚ûú  Local:   http://localhost:8080/
```

---

### Paso 3: Verificar Ambos Service Workers

1. Abrir: http://localhost:8080
2. F12 ‚Üí Application ‚Üí Service Workers

**Debe mostrar DOS service workers:**

```
1. Source: http://localhost:8080/sw.js
   Status: activated and is running
   Scope: http://localhost:8080/

2. Source: http://localhost:8080/firebase-messaging-sw.js
   Status: activated and is running
   Scope: http://localhost:8080/firebase-cloud-messaging-push-scope
```

**Consola del navegador debe mostrar:**
```
‚úÖ [FCM] Firebase Messaging SW registered: /firebase-cloud-messaging-push-scope
‚úÖ [FCM SW] Firebase Messaging Service Worker loaded
‚úÖ [FCM SW] Firebase app initialized
```

---

### Paso 4: Activar FCM Notifications

1. Ir a: http://localhost:8080/get-ready
2. Click en icono de **campana** (üîî) en topbar
3. Panel de Notification Settings se abre

**Verificar estado:**
```
‚úÖ Browser Support: Yes
‚úÖ Firebase Configured: Yes
‚ÑπÔ∏è Permission: default
```

4. **Activar el toggle: "FCM Push Notifications"**

**Navegador pedir√° permisos:**
```
"localhost:8080 wants to show notifications"
[Block] [Allow]
```

5. Click en **"Allow"**

---

### Paso 5: Verificar en Consola

**Despu√©s de activar el toggle, debe aparecer:**

```javascript
‚úÖ [Firebase] App initialized successfully
‚úÖ [Firebase] Messaging initialized successfully
‚úÖ [FCM] Using FCM Service Worker: /firebase-cloud-messaging-push-scope
‚úÖ [FCM] Requesting FCM token with VAPID key...
‚úÖ [FCM] Token received: fAkUAM8SGAMWX6rQPcK...
‚úÖ [FCM] Token saved to database
```

**Toast notification:**
```
üéâ "FCM Notifications Enabled"
   "You will now receive Firebase Cloud Messaging notifications"
```

---

### Paso 6: Enviar Notificaci√≥n de Prueba

1. En Notification Settings, click: **"Send Test Notification"**

**Consola debe mostrar:**
```
[FCM Test] Sending test notification via Edge Function
[FCM Test] Response: { success: true, sentCount: 1 }
```

**Toast:**
```
‚úÖ "Test Notification Sent"
   "Successfully sent to 1 device(s)"
```

**Notificaci√≥n del navegador:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üîî FCM Test Notification        ‚îÇ
‚îÇ This is a test notification     ‚îÇ
‚îÇ from Firebase Cloud Messaging   ‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ [View] [Dismiss]                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Qu√© Esperar

### DevTools ‚Üí Application ‚Üí Service Workers

**DOS service workers deben estar activos:**
| Service Worker | Scope | Funci√≥n |
|----------------|-------|---------|
| `sw.js` | `/` | PWA offline cache |
| `firebase-messaging-sw.js` | `/firebase-cloud-messaging-push-scope` | FCM push notifications |

### Consola del Navegador

**Al cargar la p√°gina:**
```
[FCM] Firebase Messaging SW registered: /firebase-cloud-messaging-push-scope
[FCM SW] Firebase app initialized
```

**Al activar toggle:**
```
[FCM] Using FCM Service Worker: /firebase-cloud-messaging-push-scope
[FCM] Token received: ...
[FCM] Token saved to database
```

**Al enviar test:**
```
[FCM Test] Response: { success: true, sentCount: 1 }
```

---

## ‚ùå Troubleshooting

### Error: "Firebase Messaging service worker not found"

**Causa:** El service worker de FCM no se registr√≥ correctamente

**Soluci√≥n:**
1. Verificar que `/firebase-messaging-sw.js` existe en `public/`
2. Limpiar cache y service workers
3. Refrescar p√°gina (F5)
4. Verificar que el scope sea correcto

```javascript
// En consola del navegador:
navigator.serviceWorker.getRegistrations().then(regs => {
  regs.forEach(reg => console.log('SW:', reg.scope));
});
```

---

### Error: "Push notifications not supported in this browser"

**Causa:** `isSupported` es `false`

**Verificar en consola:**
```javascript
console.log({
  hasNotification: 'Notification' in window,
  hasServiceWorker: 'serviceWorker' in navigator,
  hasPushManager: 'PushManager' in window
});
```

Todos deben ser `true`.

---

### Toggle de FCM sigue deshabilitado

**Verificar:**

```javascript
// En consola:
console.log({
  supported: // resultado de isSupported,
  configured: // resultado de isConfigured,
  permission: Notification.permission
});
```

**Si `configured` es `false`:**
- Verificar que `.env.local` tiene todas las variables `VITE_FIREBASE_*`
- Verificar que no tengan el placeholder `YOUR_`

```bash
cat .env.local | grep VITE_FIREBASE
```

---

### Notificaci√≥n no aparece

1. **Verificar permisos:**
```javascript
console.log('Permission:', Notification.permission);
// Debe ser "granted"
```

2. **Verificar token guardado:**
```sql
-- En Supabase SQL Editor:
SELECT * FROM fcm_tokens WHERE is_active = true;
```

3. **Verificar logs de Edge Function:**
```sql
SELECT * FROM edge_function_logs
WHERE function_name = 'push-notification-fcm'
ORDER BY created_at DESC
LIMIT 5;
```

---

## ‚úÖ Checklist de Validaci√≥n

Antes de marcar como completado:

- [ ] Cache del navegador limpiado completamente
- [ ] Todos los service workers anteriores unregistered
- [ ] Servidor reiniciado en puerto 8080
- [ ] DOS service workers aparecen en DevTools
  - [ ] `sw.js` (scope: `/`)
  - [ ] `firebase-messaging-sw.js` (scope: `/firebase-cloud-messaging-push-scope`)
- [ ] Consola muestra: "Firebase Messaging SW registered"
- [ ] Toggle de FCM est√° habilitado (no deshabilitado)
- [ ] Permisos de notificaci√≥n concedidos ("granted")
- [ ] Token FCM generado y guardado en base de datos
- [ ] Notificaci√≥n de prueba enviada exitosamente
- [ ] Notificaci√≥n apareci√≥ en el navegador

---

## üìä Resumen de Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Browser (localhost:8080)                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ   Service Worker 1      ‚îÇ  ‚îÇ   Service Worker 2        ‚îÇ‚îÇ
‚îÇ  ‚îÇ   (Vite PWA)            ‚îÇ  ‚îÇ   (Firebase Messaging)    ‚îÇ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÇ
‚îÇ  ‚îÇ File: sw.js (generated) ‚îÇ  ‚îÇ File: firebase-messaging- ‚îÇ‚îÇ
‚îÇ  ‚îÇ Scope: /                ‚îÇ  ‚îÇ       sw.js               ‚îÇ‚îÇ
‚îÇ  ‚îÇ Function: PWA cache     ‚îÇ  ‚îÇ Scope: /firebase-cloud-   ‚îÇ‚îÇ
‚îÇ  ‚îÇ Registration: Auto      ‚îÇ  ‚îÇ        messaging-push-    ‚îÇ‚îÇ
‚îÇ  ‚îÇ              (Vite)     ‚îÇ  ‚îÇ        scope              ‚îÇ‚îÇ
‚îÇ  ‚îÇ                         ‚îÇ  ‚îÇ Function: FCM push        ‚îÇ‚îÇ
‚îÇ  ‚îÇ                         ‚îÇ  ‚îÇ Registration: Manual      ‚îÇ‚îÇ
‚îÇ  ‚îÇ                         ‚îÇ  ‚îÇ     (useFCMNotifications) ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

**Configurado por:** Claude Code
**√öltima actualizaci√≥n:** 2025-10-19 16:15 UTC
**Versi√≥n:** Dual Service Worker Architecture
**Estado:** ‚úÖ Ready for Testing
